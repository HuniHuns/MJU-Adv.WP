{% extends 'layout.html' %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <h2 class="mb-4 fw-bold">ğŸ‘¤ ë‚´ ì •ë³´</h2>
      
    <div class="card mb-5 shadow-sm">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title text-muted mb-0">ê³„ì • ì •ë³´</h5>
          {% if user.provider == 'kakao' %}
            <span class="badge bg-warning text-dark">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘</span>
          {% else %}
            <span class="badge bg-secondary">ë¡œì»¬ ë¡œê·¸ì¸ ì¤‘</span>
          {% endif %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">ë‹‰ë„¤ì„</label>
          
          <div id="nick-view" class="d-flex align-items-center justify-content-between p-2 border rounded bg-light">
            <span class="fs-5" id="current-nick">{{ user.nickname }}</span>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleNickEdit()">ìˆ˜ì •</button>
          </div>

          <div id="nick-edit" class="d-flex gap-2 d-none">
            <input type="text" id="new-nick" class="form-control" value="{{ user.nickname }}">
            <button class="btn btn-success" onclick="updateNickname()">ì €ì¥</button>
            <button class="btn btn-secondary" onclick="toggleNickEdit()">ì·¨ì†Œ</button>
          </div>
        </div>

          <div class="mb-3">
            <label class="form-label fw-bold">ì´ë©”ì¼</label>
            <div class="p-2 border rounded bg-light text-muted">
              {{ user.email }}
            </div>
          </div>
          
          <hr>

          <div class="text-end">
            <button class="btn btn-outline-danger btn-sm" onclick="withdrawUser()">íšŒì› íƒˆí‡´</button>
          </div>
      </div>
    </div>

    <h4 class="mb-3 fw-bold">ğŸ—³ï¸ ë‚´ê°€ ì°¸ì—¬í•œ íˆ¬í‘œ ê¸°ë¡</h4>
    <div class="list-group shadow-sm">
      {% for vote in myVotes %}
      <a href="/game/{{ vote.Game.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
        <div class="text-truncate me-3">
          <span class="fw-bold">{{ vote.Game.title }}</span>
        </div>
          
        <div class="flex-shrink-0 text-end">
          <span class="badge bg-{{ 'danger' if vote.choice == 'A' else 'primary' }} rounded-pill px-3 py-2">
            {{ vote.choice }} ì„ íƒí•¨
          </span>
          <br>
          <small class="text-muted" style="font-size: 0.8rem;">{{ vote.createdAt.toLocaleDateString() }}</small>
        </div>
      </a>
      {% else %}
      <div class="list-group-item text-center text-muted py-5">
        <p class="mb-0">ì•„ì§ ì°¸ì—¬í•œ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="/game/list" class="btn btn-sm btn-primary mt-2">ê²Œì„ ì°¸ì—¬í•˜ëŸ¬ ê°€ê¸°</a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // 1. ë‹‰ë„¤ì„ ìˆ˜ì • ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
  function toggleNickEdit() {
    const viewDiv = document.getElementById('nick-view');
    const editDiv = document.getElementById('nick-edit');
    
    // í´ë˜ìŠ¤ d-none(ìˆ¨ê¹€)ì„ ë„£ì—ˆë‹¤ ëºë‹¤ í•˜ë©° ì „í™˜
    if (editDiv.classList.contains('d-none')) {
      editDiv.classList.remove('d-none');
      viewDiv.classList.add('d-none');
    } else {
      editDiv.classList.add('d-none');
      viewDiv.classList.remove('d-none');
    }
  }

  // 2. ë‹‰ë„¤ì„ ìˆ˜ì • ìš”ì²­ (Axios)
  async function updateNickname() {
    const newNick = document.getElementById('new-nick').value;
    
    if (!newNick) {
      alert('ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      await axios.patch('/user/nickname', { nickname: newNick });
      
      alert('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜
  } catch (err) {
      console.error(err);
      alert(err.response?.data || 'ìˆ˜ì • ì‹¤íŒ¨');
  }
  }

  // 3. íšŒì› íƒˆí‡´ ìš”ì²­ (Axios)
  async function withdrawUser() {
    if (!confirm('ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? íƒˆí‡´ í›„ ì •ë³´ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    try {
      await axios.delete('/user');
        
      alert('íƒˆí‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.');
      location.href = '/'; // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
    } catch (err) {
      console.error(err);
      alert(err.response?.data || 'íƒˆí‡´ ì‹¤íŒ¨');
    }
  }
</script>
{% endblock %}